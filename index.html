<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Monitor Detector</title>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Color Palette */
            --bg-body: #0f172a;       /* Dark Blue-Grey */
            --bg-card: #1e293b;       /* Slate 800 */
            --bg-card-hover: #334155;
            
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            
            --accent-color: #6366f1;  /* Indigo */
            --accent-hover: #4f46e5;
            
            --success-color: #10b981; /* Emerald */
            --danger-color: #f43f5e;  /* Rose */
            
            --border-radius: 16px;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Header Section --- */
        header {
            width: 100%;
            padding: 2rem 1rem;
            text-align: center;
            background: linear-gradient(180deg, rgba(30,41,59,0.8) 0%, rgba(15,23,42,0) 100%);
        }

        h1 {
            margin: 0;
            font-weight: 700;
            font-size: 1.8rem;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p.subtitle {
            margin-top: 8px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* --- Container Layout --- */
        .container {
            width: 100%;
            max-width: 1280px;
            padding: 0 20px 40px 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* --- Stats Cards --- */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 10px;
        }

        .stat-card {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover { transform: translateY(-2px); }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .text-green { color: var(--success-color); text-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .text-red { color: var(--danger-color); text-shadow: 0 0 20px rgba(244, 63, 94, 0.3); }

        /* --- Controls --- */
        .controls-wrapper {
            background-color: var(--bg-card);
            padding: 20px;
            border-radius: var(--border-radius);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 10px;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            background-color: rgba(30, 41, 59, 0.9);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            color: white;
        }

        .btn-primary {
            background-color: var(--accent-color);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover { background-color: var(--accent-hover); transform: translateY(-1px); }
        .btn-primary:active { transform: scale(0.98); }

        .btn-secondary {
            background-color: #334155;
            border: 1px solid #475569;
        }
        .btn-secondary:hover { background-color: #475569; }

        input[type="file"] { display: none; }

        /* --- Camera View --- */
        #camera-section {
            display: none;
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            background: #000;
        }
        video { width: 100%; height: auto; display: block; }
        
        .camera-overlay {
            position: absolute; bottom: 20px; left: 0; right: 0;
            display: flex; justify-content: center; gap: 20px;
        }

        #capture-btn {
            width: 64px; height: 64px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255,255,255,0.3);
            cursor: pointer;
            position: relative;
        }
        #capture-btn::after {
            content: ''; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            background: var(--danger-color);
            border-radius: 50%;
            transition: transform 0.1s;
        }
        #capture-btn:active::after { transform: translate(-50%, -50%) scale(0.9); }

        /* --- Results Grid --- */
        .results-section {
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 20px;
        }

        .grid-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .result-card {
            background-color: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex;
            flex-direction: column;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
        }

        .result-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent-color);
            margin: 0;
        }
        
        .result-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 0;
            margin-top: 4px;
        }

        canvas {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background-color: #000;
            border: 1px solid #334155;
            margin-top: auto; /* Push to bottom if content varies */
        }

        /* --- Highlighted Final Result --- */
        .final-result-card {
            grid-column: 1 / -1;
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 1px solid var(--accent-color);
        }
        .final-result-card .result-title {
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        /* --- Logs Section --- */
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
            margin-top: 10px;
            /* Scrollbar Styling */
            scrollbar-width: thin;
            scrollbar-color: #475569 #1e293b;
        }
        
        .logs-container::-webkit-scrollbar { width: 8px; }
        .logs-container::-webkit-scrollbar-track { background: #1e293b; }
        .logs-container::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 4px; }

        .log-entry {
            background: rgba(0,0,0,0.3);
            border-left: 4px solid #555;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #cbd5e1;
        }
        .log-entry.status-on { border-left-color: var(--success-color); background: rgba(16, 185, 129, 0.05); }
        .log-entry.status-off { border-left-color: var(--danger-color); background: rgba(244, 63, 94, 0.05); }

        .log-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 6px;
        }
        .bg-green { background-color: rgba(16, 185, 129, 0.2); color: var(--success-color); }
        .bg-red { background-color: rgba(244, 63, 94, 0.2); color: var(--danger-color); }

        /* --- Loading Spinner --- */
        #loading {
            position: fixed; inset: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .spinner {
            width: 48px; height: 48px;
            border: 4px solid #334155;
            border-bottom-color: var(--accent-color);
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            margin-bottom: 16px;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            .controls-wrapper {
                position: relative; /* Unsticky on mobile */
                top: 0;
            }
            .btn { width: 100%; justify-content: center; } /* Full width buttons */
            .grid-gallery { grid-template-columns: 1fr; } /* Single column */
            h1 { font-size: 1.5rem; }
            .stat-value { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading">
        <div class="spinner"></div>
        <div style="color: var(--text-secondary); font-weight: 500;">Memuat OpenCV System...</div>
    </div>

    <header>
        <h1>AI Monitor Detector</h1>
        <p class="subtitle">Deteksi Status Layar (ON/OFF) dengan Computer Vision</p>
    </header>

    <div class="container">
        
        <!-- Stats Widgets -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-value text-green" id="count-on">0</span>
                <span class="stat-label">Menyala (ON)</span>
            </div>
            <div class="stat-card">
                <span class="stat-value text-red" id="count-off">0</span>
                <span class="stat-label">Mati (OFF)</span>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="controls-wrapper">
            <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Upload Gambar
            </button>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
            
            <button class="btn btn-primary" onclick="startCamera()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                Buka Kamera
            </button>
        </div>

        <!-- Live Camera UI -->
        <div id="camera-section">
            <video id="videoElement" autoplay playsinline></video>
            <div class="camera-overlay">
                <button id="capture-btn" onclick="captureImage()" title="Ambil Foto"></button>
            </div>
        </div>

        <!-- Main Results Area -->
        <div class="results-section" id="output-area">
            
            <div class="grid-gallery">
                <!-- 1. Original -->
                <div class="result-card">
                    <div class="result-header">
                        <div>
                            <h3 class="result-title">1. Input Original</h3>
                            <p class="result-desc">Gambar sumber asli</p>
                        </div>
                    </div>
                    <canvas id="canvasInput"></canvas>
                </div>

                <!-- 2. Grayscale -->
                <div class="result-card">
                    <div class="result-header">
                        <div>
                            <h3 class="result-title">2. Grayscale</h3>
                            <p class="result-desc"><code>cv.cvtColor(BGR2GRAY)</code></p>
                        </div>
                    </div>
                    <canvas id="canvasGray"></canvas>
                </div>

                <!-- 3. Blur -->
                <div class="result-card">
                    <div class="result-header">
                        <div>
                            <h3 class="result-title">3. Gaussian Blur</h3>
                            <p class="result-desc">Filter (7,7) reduksi noise</p>
                        </div>
                    </div>
                    <canvas id="canvasBlur"></canvas>
                </div>

                <!-- 4. Threshold -->
                <div class="result-card">
                    <div class="result-header">
                        <div>
                            <h3 class="result-title">4. Threshold (Inv)</h3>
                            <p class="result-desc">Segmentasi biner (38, 255)</p>
                        </div>
                    </div>
                    <canvas id="canvasThresh"></canvas>
                </div>

                <!-- 5. Contours -->
                <div class="result-card">
                    <div class="result-header">
                        <div>
                            <h3 class="result-title">5. Contours Check</h3>
                            <p class="result-desc">Visualisasi kontur (Hijau)</p>
                        </div>
                    </div>
                    <canvas id="canvasContours"></canvas>
                </div>
            </div>

            <!-- 6. Final Result (Full Width) -->
            <div class="result-card final-result-card">
                <div class="result-header">
                    <div>
                        <h3 class="result-title">6. Hasil Deteksi & Analisis</h3>
                        <p class="result-desc">Klasifikasi berdasarkan area & kecerahan</p>
                    </div>
                </div>
                <canvas id="canvasOutput"></canvas>
            </div>

            <!-- 7. Detailed Logs (Full Width) -->
            <div class="result-card" style="grid-column: 1 / -1;">
                <h3 class="result-title" style="margin-bottom: 10px;">üìã Log Perhitungan Logika</h3>
                <div class="logs-container" id="detection-logs">
                    <!-- Logs injected via JS -->
                </div>
            </div>

        </div>
    </div>

    <!-- OpenCV.js Library -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady()" type="text/javascript"></script>

    <script>
        let isCvLoaded = false;
        let videoStream = null;

        function onOpenCvReady() {
            isCvLoaded = true;
            document.getElementById('loading').style.display = 'none';
            console.log('OpenCV.js Loaded');
        }

        /* --- INPUT HANDLERS --- */
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    stopCamera();
                    processImage(img);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function startCamera() {
            const video = document.getElementById('videoElement');
            const container = document.getElementById('camera-section');
            document.getElementById('output-area').style.display = 'none';
            
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = videoStream;
                container.style.display = 'block';
                // Scroll to camera
                container.scrollIntoView({ behavior: 'smooth' });
            } catch (err) {
                alert("Tidak dapat mengakses kamera. Pastikan izin diberikan.");
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                document.getElementById('camera-section').style.display = 'none';
            }
        }

        function captureImage() {
            const video = document.getElementById('videoElement');
            // Create canvas for capture
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const img = new Image();
            img.onload = function() {
                processImage(img);
                stopCamera();
            };
            img.src = canvas.toDataURL('image/jpeg');
        }

        /* --- CORE LOGIC (OPENCV) --- */
        function processImage(imgElement) {
            if (!isCvLoaded) {
                alert("Tunggu sebentar, System sedang memuat...");
                return;
            }

            // Show Results Area
            const resultsSection = document.getElementById('output-area');
            resultsSection.style.display = 'flex';
            
            // Clear previous logs
            const logsContainer = document.getElementById('detection-logs');
            logsContainer.innerHTML = ''; 

            // Initialize Mats
            let src = cv.imread(imgElement);
            let dst = new cv.Mat();
            let gray = new cv.Mat();
            let blur = new cv.Mat();
            let thresh = new cv.Mat();
            let contoursImg = new cv.Mat();
            let hierarchy = new cv.Mat();
            let contours = new cv.MatVector();

            // 1. Original
            cv.imshow('canvasInput', src);

            // 2. Grayscale
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            cv.imshow('canvasGray', gray);

            // 3. Blur
            let ksize = new cv.Size(7, 7);
            cv.GaussianBlur(gray, blur, ksize, 0);
            cv.imshow('canvasBlur', blur);

            // 4. Threshold
            cv.threshold(blur, thresh, 38, 255, cv.THRESH_BINARY_INV);
            cv.imshow('canvasThresh', thresh);

            // 5. Contours
            cv.findContours(thresh, contours, hierarchy, cv.RETR_TREE, cv.CHAIN_APPROX_SIMPLE);

            // Visualisasi Contours pada Threshold (Background grayscale converted to RGB)
            cv.cvtColor(thresh, contoursImg, cv.COLOR_GRAY2RGBA);
            // Warna Hijau Neon untuk garis
            let contourColor = new cv.Scalar(0, 255, 0, 255); 
            cv.drawContours(contoursImg, contours, -1, contourColor, 2);
            cv.imshow('canvasContours', contoursImg);

            // 6. Logic Analysis
            src.copyTo(dst);
            let onCount = 0;
            let offCount = 0;
            let monitorFound = false;

            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);

                // Filter Area > 5500
                if (area > 5500) {
                    let rect = cv.boundingRect(cnt);
                    let x = rect.x, y = rect.y, w = rect.width, h = rect.height;

                    // Filter Landscape (Width > Height)
                    if (w > h) {
                        monitorFound = true;
                        
                        // ROI Processing
                        let roiSrc = src.roi(rect);
                        let roiGray = new cv.Mat();
                        cv.cvtColor(roiSrc, roiGray, cv.COLOR_RGBA2GRAY);

                        let mean = cv.mean(roiGray);
                        let meanBrightness = mean[0]; 
                        let blackThreshold = 70;
                        
                        let statusText = "UNKNOWN";
                        let color; // RGBA Array for OpenCV
                        let cssClass = "";
                        let badgeClass = "";
                        let logicMsg = "";

                        // Decision Logic
                        if (meanBrightness < blackThreshold) {
                            statusText = "MATI (OFF)";
                            color = [244, 63, 94, 255]; // Rose Red
                            cssClass = "status-off";
                            badgeClass = "bg-red";
                            logicMsg = `Brightness <strong>${meanBrightness.toFixed(2)}</strong> < Threshold ${blackThreshold}`;
                            offCount++;
                        } else {
                            statusText = "MENYALA (ON)";
                            color = [16, 185, 129, 255]; // Emerald Green
                            cssClass = "status-on";
                            badgeClass = "bg-green";
                            logicMsg = `Brightness <strong>${meanBrightness.toFixed(2)}</strong> ‚â• Threshold ${blackThreshold}`;
                            onCount++;
                        }

                        // Draw on Final Image
                        let p1 = new cv.Point(x, y);
                        let p2 = new cv.Point(x + w, y + h);
                        cv.rectangle(dst, p1, p2, color, 3); // Tebal garis 3

                        // Label Text
                        let label = `${statusText} | Val: ${Math.round(meanBrightness)}`;
                        let textOrg = new cv.Point(x, y - 10);
                        cv.putText(dst, label, textOrg, cv.FONT_HERSHEY_SIMPLEX, 0.7, color, 2);

                        // Add Log Entry
                        let logHtml = `
                            <div class="log-entry ${cssClass}">
                                <div class="log-badge ${badgeClass}">${statusText}</div>
                                <div>Detection #${onCount + offCount}</div>
                                <div style="margin-top:4px; font-size:0.8rem; color:#94a3b8;">
                                    üìè Area: ${area} (Valid > 5500)<br>
                                    üìê Dimensi: ${w}x${h} (Landscape)<br>
                                    üí° Logika: ${logicMsg}
                                </div>
                            </div>
                        `;
                        logsContainer.insertAdjacentHTML('beforeend', logHtml);

                        roiSrc.delete(); roiGray.delete();
                    }
                }
            }

            if (!monitorFound) {
                 logsContainer.innerHTML = `
                 <div class="log-entry" style="border-left-color: #f59e0b;">
                    <span style="color:#f59e0b; font-weight:bold;">‚ö†Ô∏è Tidak ada monitor terdeteksi</span><br>
                    Pastikan gambar cukup terang dan monitor terlihat jelas (Landscape).<br>
                    Kontur terbesar saat ini tidak memenuhi syarat Area > 5500.
                 </div>`;
            }

            // Display Final Result
            cv.imshow('canvasOutput', dst);

            // Update Header Stats with Animation
            animateValue("count-on", parseInt(document.getElementById("count-on").innerText), onCount, 500);
            animateValue("count-off", parseInt(document.getElementById("count-off").innerText), offCount, 500);

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });

            // Clean Memory
            src.delete(); dst.delete(); gray.delete(); 
            blur.delete(); thresh.delete(); hierarchy.delete(); 
            contours.delete(); contoursImg.delete();
        }

        // Helper: Number Animation
        function animateValue(id, start, end, duration) {
            if (start === end) return;
            let range = end - start;
            let current = start;
            let increment = end > start ? 1 : -1;
            let stepTime = Math.abs(Math.floor(duration / range));
            let obj = document.getElementById(id);
            let timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current;
                if (current == end) { clearInterval(timer); }
            }, stepTime);
        }

    </script>
</body>
</html>