<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIP Monitor Detector</title>
    
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Color Palette */
            --bg-body: #0f172a;       /* Dark Blue-Grey */
            --bg-card: #1e293b;       /* Slate 800 */
            --bg-input: #020617;
            
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            
            --accent-color: #6366f1;  /* Indigo */
            
            --success-color: #10b981; /* Emerald */
            --danger-color: #f43f5e;  /* Rose */
            
            --border-radius: 12px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Header --- */
        header {
            width: 100%;
            padding: 1.5rem 1rem;
            text-align: center;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 50;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        h1 {
            margin: 0;
            font-size: 1.4rem;
            background: linear-gradient(to right, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- Container & Grid --- */
        .container {
            width: 100%;
            max-width: 1280px;
            padding: 20px;
            display: flex; flex-direction: column; gap: 30px;
        }

        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .stat-card {
            background: var(--bg-card); padding: 15px;
            border-radius: var(--border-radius);
            text-align: center; border: 1px solid rgba(255,255,255,0.05);
        }
        .stat-val { font-size: 1.8rem; font-weight: 800; display: block; }
        .text-green { color: var(--success-color); }
        .text-red { color: var(--danger-color); }

        /* --- Buttons --- */
        .controls {
            display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px; border-radius: 10px; border: none;
            font-weight: 600; cursor: pointer; color: white;
            display: flex; align-items: center; gap: 8px;
            transition: transform 0.1s;
        }
        .btn-primary { background: var(--accent-color); }
        .btn-secondary { background: #334155; }
        .btn:active { transform: scale(0.96); }
        input[type="file"] { display: none; }

        /* --- Camera --- */
        #camera-wrapper {
            display: none; width: 100%; max-width: 500px;
            margin: 0 auto; background: #000;
            border-radius: var(--border-radius); overflow: hidden;
            position: relative;
        }
        video { width: 100%; display: block; }
        .cam-btn {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px; border-radius: 50%; background: white;
            border: 4px solid rgba(255,255,255,0.3); cursor: pointer;
        }
        .cam-btn::after {
            content:''; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            width:45px; height:45px; background:var(--danger-color); border-radius:50%;
        }

        /* --- SECTIONS --- */
        .section-title {
            font-size: 1.1rem; color: var(--text-primary);
            border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 8px;
        }
        .badge-step {
            background: var(--accent-color); color: white;
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
        }

        .card {
            background: var(--bg-card); border-radius: var(--border-radius);
            padding: 12px; border: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column;
        }

        .card-head {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .card-title { font-size: 0.9rem; font-weight: 600; margin: 0; color: #fff; }
        .card-sub { font-size: 0.75rem; color: var(--text-secondary); margin: 0; }

        canvas {
            width: 100%; height: auto;
            background: #000; border-radius: 6px; border: 1px solid #334155;
            margin-bottom: 8px;
        }

        /* --- Analysis Box (Tracing) --- */
        .analysis-box {
            background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;
            font-size: 0.8rem; margin-top: auto;
        }
        .meta-row { display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--text-secondary); }
        .meta-val { color: white; font-weight: 600; }

        .trace-bar {
            height: 24px; background: #334155; border-radius: 4px;
            position: relative; margin-top: 8px; overflow: hidden;
        }
        .trace-limit {
            position: absolute; top:0; bottom:0; width: 2px; background: #fff; z-index: 5;
        }
        .trace-limit::after {
            content: '70'; position: absolute; top: 2px; left: 3px; font-size: 7px; background: black; padding: 1px 2px;
        }
        .trace-fill {
            height: 100%; display: flex; align-items: center; justify-content: flex-end;
            padding-right: 5px; color: white; font-size: 0.7rem; font-weight: bold;
            transition: width 0.5s;
        }
        .fill-red { background: linear-gradient(90deg, #881337, #f43f5e); }
        .fill-green { background: linear-gradient(90deg, #064e3b, #10b981); }

        /* --- Logs --- */
        .log-box {
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;
            font-family: monospace; font-size: 0.75rem; color: #cbd5e1;
            max-height: 200px; overflow-y: auto;
        }

        /* --- Loading --- */
        #loading {
            position: fixed; inset: 0; background: #0f172a; z-index: 100;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spin {
            width: 40px; height: 40px; border: 4px solid #334155;
            border-top-color: var(--accent-color); border-radius: 50%;
            animation: s 1s infinite linear; margin-bottom: 10px;
        }
        @keyframes s { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loading">
        <div class="spin"></div>
        <span>Memuat DIP Monitor Detector...</span>
    </div>

    <header>
        <h1>DIP Monitor Detector</h1>
    </header>

    <div class="container">
        
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-val text-green" id="val-on">0</span>
                <small style="color:#94a3b8">MENYALA (ON)</small>
            </div>
            <div class="stat-card">
                <span class="stat-val text-red" id="val-off">0</span>
                <small style="color:#94a3b8">MATI (OFF)</small>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-secondary" onclick="document.getElementById('upl').click()">üìÅ Upload</button>
            <input type="file" id="upl" accept="image/*" onchange="handleFile(event)">
            <button class="btn btn-primary" onclick="openCam()">üì∏ Kamera</button>
        </div>

        <div id="camera-wrapper">
            <video id="vid" autoplay playsinline></video>
            <div class="cam-btn" onclick="takePic()"></div>
        </div>

        <!-- RESULTS -->
        <div id="results" style="display:none; flex-direction:column; gap:30px;">
            
            <!-- SECTION 1: PROCESS -->
            <div>
                <h3 class="section-title"><span class="badge-step">TAHAP 1</span> Pipeline Pemrosesan Citra</h3>
                <div class="gallery-grid">
                    <!-- 1. Input -->
                    <div class="card">
                        <div class="card-head">
                            <div><div class="card-title">1. Input Original</div><div class="card-sub">Gambar mentah</div></div>
                        </div>
                        <canvas id="c-input"></canvas>
                    </div>
                    <!-- 2. Grayscale/Blur -->
                    <div class="card">
                        <div class="card-head">
                            <div><div class="card-title">2. Grayscale & Blur</div><div class="card-sub">Filter Noise</div></div>
                        </div>
                        <canvas id="c-blur"></canvas>
                    </div>
                    <!-- 3. Threshold -->
                    <div class="card">
                        <div class="card-head">
                            <div><div class="card-title">3. Binary Threshold</div><div class="card-sub">Segmentasi (Inv)</div></div>
                        </div>
                        <canvas id="c-thresh"></canvas>
                    </div>
                    <!-- 4. Contours (Modified) -->
                    <div class="card">
                        <div class="card-head">
                            <div><div class="card-title">4. Contours Check</div><div class="card-sub">Overlay di Gambar Asli (Tebal 20)</div></div>
                        </div>
                        <canvas id="c-contours"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: ANALYSIS -->
            <div>
                <h3 class="section-title"><span class="badge-step">TAHAP 2</span> Analisis Crop & Tracing Warna</h3>
                <div id="roi-container" class="gallery-grid">
                    <!-- Javascript inserts here -->
                </div>
            </div>

            <!-- SECTION 3: FINAL -->
            <div class="card" style="background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid #6366f1;">
                <div class="card-head">
                    <div>
                        <div class="card-title" style="font-size:1.1rem">Hasil Deteksi Akhir</div>
                        <div class="card-sub">Bounding Box & Status</div>
                    </div>
                </div>
                <canvas id="c-final"></canvas>
            </div>

            <!-- SECTION 4: LOGS -->
            <div class="card">
                <div class="card-title" style="margin-bottom:8px">üìã Logic Logs</div>
                <div id="sys-log" class="log-box"></div>
            </div>

        </div>
    </div>

    <!-- OpenCV -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="initCV()" type="text/javascript"></script>

    <script>
        let cvReady = false;
        let stream = null;

        function initCV() {
            cvReady = true;
            document.getElementById('loading').style.display = 'none';
        }

        function handleFile(e) {
            if(!e.target.files[0]) return;
            let reader = new FileReader();
            reader.onload = (ev) => {
                let img = new Image();
                img.onload = () => { closeCam(); runAI(img); };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        async function openCam() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('camera-wrapper').style.display = 'block';
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('vid').srcObject = stream;
        }

        function closeCam() {
            if(stream) stream.getTracks().forEach(t=>t.stop());
            document.getElementById('camera-wrapper').style.display = 'none';
        }

        function takePic() {
            let v = document.getElementById('vid');
            let c = document.createElement('canvas');
            c.width = v.videoWidth; c.height = v.videoHeight;
            c.getContext('2d').drawImage(v, 0, 0);
            let img = new Image();
            img.onload = () => { closeCam(); runAI(img); };
            img.src = c.toDataURL('image/jpeg');
        }

        function runAI(imgEl) {
            if(!cvReady) return;
            
            // UI & Reset
            document.getElementById('results').style.display = 'flex';
            let roiCont = document.getElementById('roi-container');
            let logBox = document.getElementById('sys-log');
            roiCont.innerHTML = ''; logBox.innerHTML = '';
            
            // --- OPENCV PROCESSING START ---
            
            let src = cv.imread(imgEl); // Load Gambar Asli
            let dst = new cv.Mat();      // Untuk Hasil Akhir
            let gray = new cv.Mat();
            let blur = new cv.Mat();
            let thresh = new cv.Mat();
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();

            // 1. Pre-processing
            src.copyTo(dst); // Copy untuk hasil akhir
            cv.imshow('c-input', src);

            // Grayscale + Blur
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(gray, blur, new cv.Size(7, 7), 0);
            cv.imshow('c-blur', blur);

            // Threshold (Inv)
            cv.threshold(blur, thresh, 38, 255, cv.THRESH_BINARY_INV);
            cv.imshow('c-thresh', thresh);

            // Find Contours
            cv.findContours(thresh, contours, hierarchy, cv.RETR_TREE, cv.CHAIN_APPROX_SIMPLE);
            
            // --- VISUALISASI CONTOURS (MODIFIED) ---
            // Clone gambar asli (src) agar garis hijau digambar di atas foto asli
            let contourImg = src.clone(); 
            // Draw Contours: -1 (semua), Warna Hijau, Thickness 20 (TEBAL)
            cv.drawContours(contourImg, contours, -1, new cv.Scalar(0, 255, 0, 255), 20);
            cv.imshow('c-contours', contourImg);

            // 2. Logic Loop
            let on = 0, off = 0, idx = 0;
            const MIN_AREA = 5000;
            const THRESH_VAL = 70;

            for(let i=0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);

                if(area > MIN_AREA) {
                    let rect = cv.boundingRect(cnt);

                    // Filter Landscape
                    if(rect.width > rect.height) {
                        idx++;
                        
                        // Crop dari SRC (Gambar Asli Bersih)
                        let roiSrc = src.roi(rect);
                        
                        // Hitung Brightness
                        let roiGray = new cv.Mat();
                        cv.cvtColor(roiSrc, roiGray, cv.COLOR_RGBA2GRAY);
                        let meanVal = cv.mean(roiGray)[0];

                        // Decision
                        let isOff = meanVal < THRESH_VAL;
                        let statusText = isOff ? "OFF (MATI)" : "ON (MENYALA)";
                        let colorHex = isOff ? "#f43f5e" : "#10b981";
                        let boxColor = isOff ? [244, 63, 94, 255] : [16, 185, 129, 255];
                        let barClass = isOff ? "fill-red" : "fill-green";
                        
                        if(isOff) off++; else on++;

                        // Render Card
                        let canvasId = `roi-${idx}`;
                        let pct = (meanVal / 255) * 100;
                        let limitPct = (THRESH_VAL / 255) * 100;

                        let html = `
                        <div class="card">
                            <div class="card-head">
                                <div><div class="card-title">Monitor #${idx}</div><div class="card-sub">Crop Original</div></div>
                                <span style="background:${colorHex}; color:white; padding:3px 8px; border-radius:4px; font-size:0.75rem; font-weight:bold;">${statusText}</span>
                            </div>
                            <canvas id="${canvasId}"></canvas>
                            <div class="analysis-box">
                                <div class="meta-row"><span>Area:</span><span class="meta-val">${Math.round(area)}</span></div>
                                <div class="meta-row"><span>Brightness:</span><span class="meta-val">${meanVal.toFixed(1)} / 255</span></div>
                                <div class="trace-bar">
                                    <div class="trace-limit" style="left:${limitPct}%"></div>
                                    <div class="trace-fill ${barClass}" style="width:${pct}%">${Math.round(meanVal)}</div>
                                </div>
                            </div>
                        </div>`;
                        
                        let div = document.createElement('div');
                        div.innerHTML = html;
                        roiCont.appendChild(div.firstElementChild);
                        cv.imshow(canvasId, roiSrc); // Show Clean Crop

                        // Draw Final Result
                        cv.rectangle(dst, new cv.Point(rect.x, rect.y), new cv.Point(rect.x+rect.width, rect.y+rect.height), boxColor, 5);
                        cv.putText(dst, `#${idx} ${statusText}`, new cv.Point(rect.x, rect.y-10), cv.FONT_HERSHEY_SIMPLEX, 0.8, boxColor, 2);

                        logBox.innerHTML += `<div>[#${idx}] Area:${area} | Brightness:${meanVal.toFixed(2)}</div>`;
                        
                        roiSrc.delete(); roiGray.delete();
                    } else {
                        logBox.innerHTML += `<div style="color:#64748b">[-] Skip Portrait Area: ${area}</div>`;
                    }
                }
            }

            if(idx === 0) {
                roiCont.innerHTML = `<div style="grid-column:1/-1; padding:20px; text-align:center; color:#94a3b8; border:1px dashed #334155; border-radius:8px;">Tidak ada area valid > 5000 & Landscape</div>`;
            }

            cv.imshow('c-final', dst);
            document.getElementById('val-on').innerText = on;
            document.getElementById('val-off').innerText = off;
            document.getElementById('results').scrollIntoView({behavior:'smooth'});

            // Cleanup
            src.delete(); dst.delete(); gray.delete(); blur.delete(); 
            thresh.delete(); contours.delete(); hierarchy.delete(); contourImg.delete();
        }
    </script>
</body>
</html>