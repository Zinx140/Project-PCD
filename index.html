<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deteksi Monitor Menyala - DIP</title>
    <!-- Font Modern -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady()"
        type="text/javascript"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --success: #22c55e;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(to right, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-badge {
            background: #334155;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--danger);
        }

        .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            width: 100%;
            max-width: 800px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        video,
        canvas {
            width: 100%;
            max-width: 100%;
            border-radius: 8px;
            background: #000;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        button:disabled {
            background-color: #475569;
            cursor: not-allowed;
            transform: none;
        }

        .result-stats {
            margin-top: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .count-on {
            color: var(--success);
        }

        .hidden {
            display: none;
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid var(--primary);
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 1fr 1fr;
            }

            .full-width {
                grid-column: span 2;
            }
        }
    </style>
</head>

<body>

    <h1>Detektor Monitor Cerdas</h1>

    <div class="status-badge">
        <div id="cvStatusColor" class="indicator"></div>
        <span id="cvStatusText">Memuat OpenCV...</span>
        <div id="loader" class="loader"></div>
    </div>

    <div class="container">
        <!-- Kamera Input -->
        <div class="card full-width">
            <div style="position: relative; width: 100%;">
                <video id="videoInput" playsinline autoplay></video>
                <canvas id="canvasOutput" class="hidden"></canvas>
            </div>

            <div class="controls">
                <button id="startCamBtn" onclick="startCamera()">ðŸ“· Buka Kamera</button>
                <button id="captureBtn" onclick="processImage()" disabled>âœ¨ Deteksi & Hitung</button>
                <button id="resetBtn" onclick="resetApp()" class="hidden">ðŸ”„ Reset</button>
            </div>
        </div>

        <!-- Hasil Pemrosesan -->
        <div class="card full-width" id="resultCard" style="display:none;">
            <h3>Hasil Analisis</h3>
            <div class="result-stats">
                Monitor Menyala: <span class="count-on" id="onCount">0</span>
            </div>
            <p style="font-size: 0.9rem; color: #94a3b8; text-align: center; margin-top:5px;">
                Kotak Hijau: Menyala | Kotak Merah: Mati
            </p>
        </div>
    </div>

    <script>
        let video = document.getElementById('videoInput');
        let canvas = document.getElementById('canvasOutput');
        let ctx = canvas.getContext('2d');
        let startBtn = document.getElementById('startCamBtn');
        let captureBtn = document.getElementById('captureBtn');
        let resetBtn = document.getElementById('resetBtn');
        let stream = null;
        let openCVReady = false;

        // 1. Inisialisasi OpenCV
        function onOpenCvReady() {
            openCVReady = true;
            document.getElementById('cvStatusColor').style.backgroundColor = 'var(--success)';
            document.getElementById('cvStatusText').innerText = "Sistem Siap";
            document.getElementById('loader').style.display = 'none';
        }

        // 2. Fungsi Kamera
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment', // Kamera belakang di HP
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.classList.remove('hidden');
                canvas.classList.add('hidden');
                document.getElementById('resultCard').style.display = 'none';

                video.onloadedmetadata = () => {
                    captureBtn.disabled = false;
                    startBtn.classList.add('hidden');
                };
            } catch (err) {
                alert("Gagal mengakses kamera: " + err);
            }
        }

        // 3. Logika Utama: Image Processing
        function processImage() {
            if (!openCVReady) {
                alert("Tunggu sebentar, sedang memuat library AI...");
                return;
            }

            // Atur ukuran canvas sesuai video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Gambar frame video ke canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Sembunyikan video, tampilkan canvas hasil
            video.classList.add('hidden');
            canvas.classList.remove('hidden');
            captureBtn.classList.add('hidden');
            resetBtn.classList.remove('hidden');
            document.getElementById('resultCard').style.display = 'block';

            // --- MULAI PEMROSESAN OPENCV ---
            let src = cv.imread(canvas);
            let dst = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC3);
            let gray = new cv.Mat();
            let blur = new cv.Mat();
            let edges = new cv.Mat();
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();

            // A. Preprocessing (Grayscale + Blur)
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
            cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 0);

            // B. Segmentasi (Canny Edge Detection)
            // Menggunakan Canny untuk menemukan garis tepi layar monitor
            cv.Canny(blur, edges, 50, 150);

            // C. Find Contours
            cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            let monitorCount = 0;

            // Loop semua kontur
            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);

                // Aproksimasi bentuk (menyederhanakan poligon)
                let peri = cv.arcLength(cnt, true);
                let approx = new cv.Mat();
                cv.approxPolyDP(cnt, approx, 0.04 * peri, true);

                // Filter: Harus memiliki 4 sudut (persegi panjang) dan area cukup besar
                let area = cv.contourArea(cnt);

                // Area threshold disesuaikan (misal > 2000px) agar tidak mendeteksi noise kecil
                if (approx.rows === 4 && area > 2000) {
                    let rect = cv.boundingRect(cnt);

                    // Filter Aspect Ratio (Monitor biasanya 16:9 atau 4:3, jadi rasio 1.3 - 2.0)
                    // Kita buat range agak lebar (0.5 - 2.5) untuk antisipasi sudut miring
                    let aspectRatio = rect.width / rect.height;

                    if (aspectRatio > 0.5 && aspectRatio < 3.0) {

                        // D. Deteksi Apakah Menyala (Menggunakan HSV)
                        // Ambil Region of Interest (ROI) dari gambar asli
                        let roi = src.roi(rect);
                        let hsvRoi = new cv.Mat();

                        // Convert ROI ke HSV
                        cv.cvtColor(roi, hsvRoi, cv.COLOR_RGBA2RGB); // Fix channel issue
                        cv.cvtColor(hsvRoi, hsvRoi, cv.COLOR_RGB2HSV);

                        // Hitung rata-rata warna di area ini
                        let mean = cv.mean(hsvRoi);
                        // mean[0] = Hue, mean[1] = Saturation, mean[2] = Value (Brightness)

                        // LOGIKA PENENTUAN:
                        // Monitor menyala biasanya memiliki Value (Brightness) tinggi 
                        // ATAU Saturation tertentu jika menampilkan warna.
                        // Layar mati biasanya hitam/abu gelap (Value rendah).

                        let isMonitorOn = false;

                        // Threshold Brightness (0-255). Jika rata-rata > 80, anggap menyala.
                        if (mean[2] > 80) {
                            isMonitorOn = true;
                        }

                        // Gambar Bounding Box
                        let color;
                        if (isMonitorOn) {
                            color = new cv.Scalar(0, 255, 0, 255); // Hijau (RGBA)
                            monitorCount++;
                        } else {
                            color = new cv.Scalar(255, 0, 0, 255); // Merah (RGBA)
                        }

                        // Gambar kotak di image asli (src) -> nanti di show di dst
                        let p1 = new cv.Point(rect.x, rect.y);
                        let p2 = new cv.Point(rect.x + rect.width, rect.y + rect.height);
                        cv.rectangle(src, p1, p2, color, 4, cv.LINE_AA, 0);

                        // Label text
                        cv.putText(src, isMonitorOn ? "ON" : "OFF", { x: rect.x, y: rect.y - 10 },
                            cv.FONT_HERSHEY_SIMPLEX, 0.8, color, 2);

                        // Cleanup memori loop
                        roi.delete(); hsvRoi.delete();
                    }
                }
                approx.delete();
            }

            // Tampilkan hasil
            cv.imshow('canvasOutput', src);
            document.getElementById('onCount').innerText = monitorCount;

            // Cleanup memori global
            src.delete(); dst.delete(); gray.delete();
            blur.delete(); edges.delete(); contours.delete();
            hierarchy.delete();
        }

        function resetApp() {
            canvas.classList.add('hidden');
            video.classList.remove('hidden');
            captureBtn.classList.remove('hidden');
            captureBtn.disabled = false;
            resetBtn.classList.add('hidden');
            document.getElementById('resultCard').style.display = 'none';
            startBtn.classList.add('hidden'); // Tetap sembunyi karena stream masih jalan
        }

    </script>
</body>

</html>