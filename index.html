<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detektor Monitor (DIP)</title>
    <style>
        :root {
            --primary: #007bff;
            --bg: #f4f4f9;
            --text: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .status-box {
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .result-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-weight: bold;
        }

        .stat-on {
            color: #28a745;
        }

        .stat-off {
            color: #dc3545;
        }

        canvas {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        #loading {
            color: var(--primary);
            font-weight: bold;
            display: block;
            text-align: center;
            margin-bottom: 10px;
        }

        /* Responsive Adjustments */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.2rem;
            }

            .container {
                padding: 15px;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Detektor Status Monitor (Non-AI)</h1>

        <div id="loading">Memuat Library OpenCV.js... (Mohon Tunggu)</div>

        <div class="controls">
            <!-- Input Camera Environment untuk kamera belakang HP -->
            <label for="fileInput" class="btn">
                ðŸ“· Ambil / Upload Foto
            </label>
            <input type="file" id="fileInput" accept="image/*" capture="environment">
        </div>

        <div class="status-box">
            <div id="statusText">Siap memproses gambar.</div>
            <div class="result-stats" id="stats" style="display:none;">
                <span class="stat-on">Menyala: <span id="countOn">0</span></span>
                <span class="stat-off">Mati: <span id="countOff">0</span></span>
            </div>
        </div>

        <!-- Canvas untuk hasil output -->
        <canvas id="canvasOutput"></canvas>
        <!-- Image source hidden -->
        <img id="imageSrc" alt="No Image" style="display:none;" />
    </div>

    <!-- Load OpenCV.js -->
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();"
        type="text/javascript"></script>

    <script type="text/javascript">
        let cvReady = false;

        function onOpenCvReady() {
            cvReady = true;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('statusText').innerText = "OpenCV Siap. Silakan upload foto.";
        }

        const fileInput = document.getElementById('fileInput');
        const imageSrc = document.getElementById('imageSrc');
        const canvasOutput = document.getElementById('canvasOutput');
        const statusText = document.getElementById('statusText');
        const statsDiv = document.getElementById('stats');
        const countOnSpan = document.getElementById('countOn');
        const countOffSpan = document.getElementById('countOff');

        fileInput.addEventListener('change', (e) => {
            if (!cvReady) {
                alert("OpenCV belum siap, tunggu sebentar.");
                return;
            }
            if (e.target.files.length === 0) return;

            statusText.innerText = "Memproses gambar...";
            imageSrc.src = URL.createObjectURL(e.target.files[0]);
        });

        imageSrc.onload = function () {
            processImage();
        };

        function processImage() {
            try {
                // 1. Persiapan Matriks Gambar
                let src = cv.imread(imageSrc);
                let dst = new cv.Mat();
                let gray = new cv.Mat();
                let blur = new cv.Mat();
                let edges = new cv.Mat();

                // 2. Pre-processing: Grayscale & Gaussian Blur (Mengurangi noise)
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
                let ksize = new cv.Size(5, 5);
                cv.GaussianBlur(gray, blur, ksize, 0, 0, cv.BORDER_DEFAULT);

                // 3. Deteksi Tepi (Canny Edge Detection)
                // Threshold bisa disesuaikan tergantung kondisi cahaya
                cv.Canny(blur, edges, 50, 150, 3, false);

                // 4. Mencari Kontur (Bentuk tertutup)
                let contours = new cv.MatVector();
                let hierarchy = new cv.Mat();
                cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                let monitorCountOn = 0;
                let monitorCountOff = 0;

                // Salin gambar asli ke dst untuk digambar hasil akhirnya
                src.copyTo(dst);

                for (let i = 0; i < contours.size(); ++i) {
                    let cnt = contours.get(i);

                    // 5. Filter Kontur: Luas Area
                    // Abaikan yang terlalu kecil (noise) atau terlalu besar (background)
                    let area = cv.contourArea(cnt);
                    let imageArea = src.cols * src.rows;

                    // Contoh: Monitor minimal 1% dari total foto, max 90%
                    if (area < (imageArea * 0.01) || area > (imageArea * 0.9)) {
                        continue;
                    }

                    // 6. Aproksimasi Poligon (Mengatasi border radius/sudut tumpul)
                    let peri = cv.arcLength(cnt, true);
                    let approx = new cv.Mat();
                    // Epsilon 0.02-0.04 biasanya bagus untuk menyederhanakan bentuk menjadi segiempat
                    cv.approxPolyDP(cnt, approx, 0.02 * peri, true);

                    // Kita mencari objek yang memiliki 4 sudut (segiempat)
                    // Karena ada border radius, kadang terdeteksi 5-8 titik, jadi kita beri toleransi
                    if (approx.rows >= 4 && approx.rows <= 8) {

                        // Buat Bounding Rect untuk analisis ROI (Region of Interest)
                        let rect = cv.boundingRect(approx);
                        let aspectRatio = rect.width / rect.height;

                        // Filter Rasio Aspek Monitor (Biasanya Landscape: > 1.0)
                        // Monitor standar 16:9 (1.77) atau 4:3 (1.33)
                        // Kita beri rentang longgar 0.8 sampai 2.5
                        if (aspectRatio >= 0.8 && aspectRatio <= 2.5) {

                            // 7. Analisis ON/OFF Berdasarkan Kecerahan (Luminance)
                            // Ambil potongan gambar di area kotak tersebut
                            let roi = gray.roi(rect);
                            let mean = cv.mean(roi); // Rata-rata kecerahan piksel (0-255)

                            // Logika Thresholding Sederhana:
                            // Jika rata-rata kecerahan > Threshold, kemungkinan NYALA.
                            // Jika kurang, kemungkinan MATI.
                            // Monitor mati yang memantulkan cahaya biasanya masih lebih gelap rata-ratanya 
                            // dibanding monitor yang memancarkan cahaya putih/berwarna.
                            let brightnessThreshold = 70; // Bisa disesuaikan

                            let color;
                            let label;

                            if (mean[0] > brightnessThreshold) {
                                monitorCountOn++;
                                color = new cv.Scalar(0, 255, 0, 255); // Hijau (RGBA)
                                label = "ON";
                            } else {
                                monitorCountOff++;
                                color = new cv.Scalar(255, 0, 0, 255); // Merah (RGBA)
                                label = "OFF";
                            }

                            // 8. Menggambar Hasil di Gambar
                            let p1 = new cv.Point(rect.x, rect.y);
                            let p2 = new cv.Point(rect.x + rect.width, rect.y + rect.height);

                            // Gambar kotak
                            cv.rectangle(dst, p1, p2, color, 3, cv.LINE_AA, 0);

                            // Tulis Label
                            cv.putText(dst, label + " (" + Math.round(mean[0]) + ")", new cv.Point(rect.x, rect.y - 10), cv.FONT_HERSHEY_SIMPLEX, 0.8, color, 2);

                            // Bersihkan memori ROI
                            roi.delete();
                        }
                    }
                    approx.delete();
                }

                // Tampilkan hasil ke Canvas
                cv.imshow('canvasOutput', dst);

                // Update Statistik UI
                statusText.innerText = "Selesai!";
                statsDiv.style.display = 'flex';
                countOnSpan.innerText = monitorCountOn;
                countOffSpan.innerText = monitorCountOff;

                // Bersihkan Memori OpenCV (Wajib agar browser tidak crash)
                src.delete(); dst.delete(); gray.delete(); blur.delete();
                edges.delete(); contours.delete(); hierarchy.delete();

            } catch (err) {
                console.error(err);
                statusText.innerText = "Terjadi kesalahan saat memproses.";
            }
        }
    </script>
</body>

</html>