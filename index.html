<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor Detector Live</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }

        body {
            background: #111;
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Area Kamera & Canvas */
        .view-port {
            position: relative;
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        video,
        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #outputCanvas {
            z-index: 2;
            pointer-events: none;
        }

        /* Hasil Draw di atas video */

        /* UI Overlay Modern */
        .hud {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            gap: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-shadow: 0 1px 2px black;
        }

        .st-on {
            color: #4ade80;
        }

        .st-off {
            color: #f87171;
        }

        .btn-capture {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: transform 0.1s;
        }

        .btn-capture:active {
            transform: scale(0.9);
            background: #eee;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00bcd4;
            z-index: 20;
        }
    </style>
</head>

<body>

    <div id="loading">Memuat OpenCV...</div>

    <div class="view-port">
        <!-- Live Video Feed -->
        <video id="videoCam" autoplay playsinline muted></video>
        <!-- Canvas untuk menampilkan hasil deteksi (disembunyikan default sampai dicapture) -->
        <canvas id="outputCanvas"></canvas>
    </div>

    <div class="hud">
        <div class="stats-card">
            <span class="st-on">ON: <span id="cntOn">0</span></span>
            <span class="st-off">OFF: <span id="cntOff">0</span></span>
        </div>
        <button class="btn-capture" id="snapBtn" onclick="processFrame()"></button>
        <small style="opacity: 0.7; margin-bottom: 5px;">Tap tombol putih untuk scan</small>
    </div>

    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="initOpenCV()"></script>

    <script>
        let video = document.getElementById('videoCam');
        let outCanvas = document.getElementById('outputCanvas');
        let ctx = outCanvas.getContext('2d');
        let streamActive = false;

        function initOpenCV() {
            document.getElementById('loading').style.display = 'none';
            startCamera();
        }

        async function startCamera() {
            try {
                // Meminta akses kamera belakang (environment)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    // Sesuaikan ukuran canvas dengan video
                    outCanvas.width = video.videoWidth;
                    outCanvas.height = video.videoHeight;
                    streamActive = true;
                };
            } catch (err) {
                alert("Gagal akses kamera: " + err);
            }
        }

        function processFrame() {
            if (!streamActive) return;

            // 1. Ambil frame dari video ke canvas
            outCanvas.width = video.videoWidth;
            outCanvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, outCanvas.width, outCanvas.height);

            // 2. OpenCV Processing
            let src = cv.imread(outCanvas);
            let gray = new cv.Mat();
            let blur = new cv.Mat();
            let edges = new cv.Mat();

            // Konversi ke Grayscale & Blur
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            cv.GaussianBlur(gray, blur, new cv.Size(5, 5), 0);

            // Deteksi Tepi (Parameter dilonggarkan agar menangkap garis monitor redup)
            cv.Canny(blur, edges, 30, 100);

            // Cari Kontur
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            let countOn = 0;
            let countOff = 0;

            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);

                // Filter ukuran (sesuaikan min/max area tergantung resolusi)
                if (area < 5000 || area > (src.cols * src.rows * 0.9)) continue;

                // Aproksimasi Poligon (Handling bentuk trapesium/sudut miring)
                let peri = cv.arcLength(cnt, true);
                let approx = new cv.Mat();
                cv.approxPolyDP(cnt, approx, 0.03 * peri, true);

                // Kita terima segiempat (4 titik) atau agak bulat (sampai 8 titik)
                if (approx.rows >= 4 && approx.rows <= 8) {

                    // MASKING: Kunci untuk deteksi sudut miring
                    // Kita buat "topeng" hitam putih sesuai bentuk kontur persis
                    let mask = new cv.Mat.zeros(gray.rows, gray.cols, cv.CV_8U);
                    let polyVector = new cv.MatVector();
                    polyVector.push_back(approx); // Gunakan bentuk approx

                    // Isi dalam kontur dengan warna putih (255)
                    cv.drawContours(mask, polyVector, 0, new cv.Scalar(255), -1);

                    // Hitung rata-rata kecerahan HANYA di dalam area putih tersebut
                    let mean = cv.mean(gray, mask);

                    // Threshold penentu ON/OFF
                    let status = mean[0] > 75; // Nilai ambang batas kecerahan
                    let color = status ? new cv.Scalar(0, 255, 0, 255) : new cv.Scalar(255, 0, 0, 255);

                    if (status) countOn++; else countOff++;

                    // Gambar garis mengikuti bentuk monitor (bukan kotak kaku)
                    cv.drawContours(src, polyVector, 0, color, 4);

                    // Tulis text di titik pertama kontur
                    let p = approx.data32S;
                    cv.putText(src, (status ? "ON" : "OFF"), new cv.Point(p[0], p[1]), cv.FONT_HERSHEY_SIMPLEX, 1, color, 2);

                    mask.delete(); polyVector.delete();
                }
                approx.delete();
            }

            // Tampilkan hasil
            cv.imshow('outputCanvas', src);

            // Update UI
            document.getElementById('cntOn').innerText = countOn;
            document.getElementById('cntOff').innerText = countOff;

            // Cleanup
            src.delete(); gray.delete(); blur.delete(); edges.delete();
            contours.delete(); hierarchy.delete();
        }
    </script>
</body>

</html>