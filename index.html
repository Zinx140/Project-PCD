<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Detector Pro (Camera Only)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady()"
        type="text/javascript"></script>

    <style>
        :root {
            --primary: #0ea5e9;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --success: #22c55e;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        h1 {
            margin-bottom: 5px;
            text-align: center;
            background: linear-gradient(to right, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .status-text {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            position: relative;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            min-height: 300px;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video,
        canvas {
            width: 100%;
            height: auto;
            display: block;
        }

        .controls {
            padding: 20px;
            display: flex;
            gap: 12px;
            justify-content: center;
            background: #1e293b;
            border-top: 1px solid #334155;
        }

        button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            background: var(--primary);
            color: white;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        button:disabled {
            background: #475569;
            cursor: not-allowed;
            filter: none;
            transform: none;
        }

        .btn-reset {
            background: #64748b;
        }

        /* Hasil Statistik */
        .result-overlay {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 120px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .bg-green {
            background: var(--success);
        }

        .bg-red {
            background: var(--danger);
        }

        .val-green {
            color: var(--success);
        }

        .val-red {
            color: var(--danger);
        }

        .hidden {
            display: none !important;
        }

        .loader {
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <h1>Monitor Detector Pro</h1>
    <div class="status-text">
        <span id="systemStatus">Memuat AI Engine... <div class="loader"
                style="display:inline-block; vertical-align:middle;"></div></span>
    </div>

    <div class="container">
        <div class="card">
            <div class="video-wrapper">
                <video id="videoInput" playsinline autoplay muted></video>
                <canvas id="canvasOutput" class="hidden"></canvas>

                <!-- Overlay Hasil Real-time -->
                <div id="statsOverlay" class="result-overlay hidden">
                    <div class="stat-row">
                        <span><span class="dot bg-green"></span>Menyala</span>
                        <span id="countOn" class="val-green">0</span>
                    </div>
                    <div class="stat-row">
                        <span><span class="dot bg-red"></span>Mati</span>
                        <span id="countOff" class="val-red">0</span>
                    </div>
                </div>
            </div>

            <div class="controls">
                <button id="camBtn" onclick="startCamera()">ðŸ“· Buka Kamera</button>
                <button id="processBtn" onclick="detectMonitor()" disabled>âœ¨ Deteksi (Scan)</button>
                <button id="retryBtn" onclick="resetCamera()" class="hidden btn-reset">ðŸ”„ Ulangi</button>
            </div>
        </div>
        <p style="text-align: center; color: #64748b; font-size: 0.8rem; margin-top: 0;">
            Tips: Pastikan seluruh bingkai monitor terlihat jelas di layar.
        </p>
    </div>

    <script>
        let video = document.getElementById('videoInput');
        let canvas = document.getElementById('canvasOutput');
        let ctx = canvas.getContext('2d', { willReadFrequently: true });
        let stream = null;
        let cvReady = false;

        function onOpenCvReady() {
            cvReady = true;
            document.getElementById('systemStatus').innerHTML = "âœ… Sistem Siap";
            document.getElementById('systemStatus').style.color = "var(--success)";
        }

        async function startCamera() {
            try {
                // Minta resolusi tinggi agar detail bingkai terlihat jelas
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    document.getElementById('camBtn').classList.add('hidden');
                    document.getElementById('processBtn').disabled = false;
                };
            } catch (err) {
                alert("Gagal akses kamera. Pastikan izin diberikan.");
            }
        }

        function detectMonitor() {
            if (!cvReady) return;

            // Setup UI
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            video.classList.add('hidden');
            canvas.classList.remove('hidden');
            document.getElementById('processBtn').classList.add('hidden');
            document.getElementById('retryBtn').classList.remove('hidden');
            document.getElementById('statsOverlay').classList.remove('hidden');

            // --- MULAI IMAGE PROCESSING ---
            let src = cv.imread(canvas);
            let dst = src.clone();
            let gray = new cv.Mat();
            let claheMat = new cv.Mat();
            let blur = new cv.Mat();
            let edges = new cv.Mat();
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();

            // 1. Grayscale
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

            // 2. CLAHE (Contrast Limited Adaptive Histogram Equalization) - SOLUSI UTAMA
            // Ini membuat area abu-abu gelap menjadi lebih kontras terhadap bingkai hitam
            let clahe = new cv.CLAHE(2.0, new cv.Size(8, 8));
            clahe.apply(gray, claheMat);

            // 3. Blur (Mengurangi noise bintik-bintik setelah CLAHE)
            cv.GaussianBlur(claheMat, blur, new cv.Size(7, 7), 0);

            // 4. Edge Detection (Canny)
            // Menggunakan threshold yang lebih sensitif karena kontras sudah dinaikkan oleh CLAHE
            cv.Canny(blur, edges, 25, 75);

            // 5. Morphology (Dilate & Close)
            // Menutup celah pada garis bingkai yang mungkin terputus
            let kernel = cv.Mat.ones(3, 3, cv.CV_8U);
            cv.dilate(edges, edges, kernel, new cv.Point(-1, -1), 2); // Penebalan cukup agresif (2 iterasi)
            cv.morphologyEx(edges, edges, cv.MORPH_CLOSE, kernel);

            // 6. Find Contours
            cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

            let onCount = 0;
            let offCount = 0;

            // Loop setiap kontur
            for (let i = 0; i < contours.size(); ++i) {
                let cnt = contours.get(i);
                let area = cv.contourArea(cnt);

                // Filter Noise Kecil
                if (area < 5000) continue;

                // Analisis Bentuk
                let peri = cv.arcLength(cnt, true);
                let approx = new cv.Mat();
                cv.approxPolyDP(cnt, approx, 0.02 * peri, true); // Toleransi agak ketat agar bentuk kotak terjaga

                let rect = cv.boundingRect(cnt);
                let aspectRatio = rect.width / rect.height;

                // Convex Hull Check (Soliditas)
                let hull = new cv.Mat();
                cv.convexHull(cnt, hull);
                let hullArea = cv.contourArea(hull);
                let solidity = area / hullArea;

                // LOGIKA FILTER BENTUK MONITOR:
                // 1. Aspect Ratio: Monitor melebar (1.2 - 2.5) atau ultrawide (< 3.5).
                // 2. Solidity: Harus > 0.9 (Objek padat/cembung, bukan kabel melingkar).
                // 3. Extent: Area kontur dibanding area bounding box kotak harus tinggi (> 0.7).
                let extent = area / (rect.width * rect.height);

                if (aspectRatio > 1.2 && aspectRatio < 3.5 && solidity > 0.9 && extent > 0.7) {

                    // --- DETEKSI STATUS (ON/OFF) ---

                    // Crop bagian tengah (Inner Crop)
                    // Ambil 30% margin dari pinggir untuk benar-benar menghindari bingkai
                    let marginX = Math.floor(rect.width * 0.3);
                    let marginY = Math.floor(rect.height * 0.3);

                    if (rect.width > 2.2 * marginX) {
                        let innerRect = new cv.Rect(
                            rect.x + marginX,
                            rect.y + marginY,
                            rect.width - (2 * marginX),
                            rect.height - (2 * marginY)
                        );

                        let roi = src.roi(innerRect);
                        let hsvRoi = new cv.Mat();

                        // Konversi ke HSV
                        cv.cvtColor(roi, hsvRoi, cv.COLOR_RGBA2RGB);
                        cv.cvtColor(hsvRoi, hsvRoi, cv.COLOR_RGB2HSV);

                        let mean = cv.mean(hsvRoi);
                        // mean[2] = Brightness (Value)

                        // --- LOGIKA WARNA ABU-ABU GELAP ---
                        // Monitor mati biasanya brightness < 40.
                        // Monitor nyala (dark mode) biasanya brightness 50 - 90.
                        // Monitor nyala (putih/terang) brightness > 100.

                        let isMonitorOn = false;

                        // Kita turunkan threshold menjadi 55 untuk menangkap layar dark mode
                        if (mean[2] > 55) {
                            isMonitorOn = true;
                        }

                        // VISUALISASI
                        let color;
                        if (isMonitorOn) {
                            onCount++;
                            color = new cv.Scalar(0, 255, 0, 255); // Hijau
                        } else {
                            offCount++;
                            color = new cv.Scalar(255, 0, 0, 255); // Merah
                        }

                        // Gambar kotak tebal
                        cv.rectangle(dst, new cv.Point(rect.x, rect.y), new cv.Point(rect.x + rect.width, rect.y + rect.height), color, 4);

                        // Label Info
                        let label = isMonitorOn ? `ON (V:${Math.round(mean[2])})` : `OFF (V:${Math.round(mean[2])})`;

                        // Background label agar terbaca
                        cv.rectangle(dst, new cv.Point(rect.x, rect.y - 25), new cv.Point(rect.x + 160, rect.y), color, -1);
                        cv.putText(dst, label, { x: rect.x + 5, y: rect.y - 7 }, cv.FONT_HERSHEY_SIMPLEX, 0.6, new cv.Scalar(255, 255, 255, 255), 2);

                        roi.delete(); hsvRoi.delete();
                    }
                }
                approx.delete(); hull.delete();
            }

            // Tampilkan Hasil
            cv.imshow('canvasOutput', dst);
            document.getElementById('countOn').innerText = onCount;
            document.getElementById('countOff').innerText = offCount;

            // Cleanup
            src.delete(); dst.delete(); gray.delete(); blur.delete();
            edges.delete(); kernel.delete(); contours.delete(); hierarchy.delete();
            clahe.delete(); claheMat.delete();
        }

        function resetCamera() {
            canvas.classList.add('hidden');
            document.getElementById('statsOverlay').classList.add('hidden');
            video.classList.remove('hidden');
            document.getElementById('processBtn').classList.remove('hidden');
            document.getElementById('retryBtn').classList.add('hidden');
        }
    </script>
</body>

</html>